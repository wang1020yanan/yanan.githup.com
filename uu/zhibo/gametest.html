<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title></title>
    <script src="js/lufy.js"></script>
    <script src="js/box2d.js"></script>
    <style>
        *{padding: 0;margin: 0}
        canvas{
            width: 100%;
            height: 100%;
        }
    </style>
    <script>
        init(100,"mylegend",1000,600,main);
        var backLayer,cLayer,wallLayer,bitmap,loadingLayer,bird,background,hero,bStage,aaa=0;
        var STAGE_STEP=10;
        var speedX=0,speedY=10;
        var imgList = {};
        var imgData = new Array(
                {name:"bird1",path:"./img/bird1.png"},
                {name:'man',path:'img/man.png'},
                {name:"bird2",path:"./img/bird2.png"},
                {name:"band",path:"./img/band.png"},
                {name:"bullet",path:"./img/bullet.png"},
                {name:"bg",path:"./img/bg2.png"},
                {name:'start',path:'img/start.png'}
        );
        LGlobal.stageScale = LStageScaleMode.EXACT_FIT;
        LSystem.screen(LStage.FULL_SCREEN);
        function main(){
            LGlobal.setDebug(true);
            backLayer = new LSprite();
            addChild(backLayer);
            loadingLayer = new LoadingSample3();
            backLayer.addChild(loadingLayer);
            LLoadManage.load(
                    imgData,
                    function(progress){
                        loadingLayer.setProgress(progress);
                    },
                    function(result){
                        imgList = result;
                        backLayer.removeChild(loadingLayer);
                        loadingLayer = null;
                        var startBtn= getBtn("start",400,300);
                        startBtn.addEventListener(LMouseEvent.MOUSE_UP,gameInit);
                        backLayer.addChild(startBtn);
                    }
            );
        }
        //        按钮获取
        function getBtn(v,x,y){
            var buU=new LBitmap(new LBitmapData(imgList[v]));
            buU.x=x;
            buU.y=y;
            buU.scaleX=1;
            buU.scaleY=1;
            var buO=new LBitmap(new LBitmapData(imgList[v]));
            buO.scaleX=1;
            buO.scaleY=1;
            buO.x=x;
            buO.y=y;
            var btn=new LButton(buU,buO);
            btn.cursor=
                    btn.name=v;
            return btn;
        }
        function gameInit(event){
            backLayer.die();
            backLayer.removeAllChild();
            LGlobal.box2d = new LBox2d();
            background=new BackGround();
//            console.log(background);
            backLayer.addChild(background);
//            stageInit();
//            添加地面和围墙
//            wallLayer = new LSprite();
//            wallLayer.graphics.drawRect(10,"#000000",[0, 0, 1000, 550],true,"#cccc80");
//            wallLayer.alpha = 0;
//            backLayer.addChild(wallLayer);
//            wallLayer = new LSprite();
//            wallLayer.x = 500;
//            wallLayer.y = 0;
//            backLayer.addChild(wallLayer);
//            wallLayer.addBodyPolygon(1000,10,0);
//            wallLayer = new LSprite();
//            wallLayer.x = 1000;
//            wallLayer.y = 0;
//
//            backLayer.addChild(wallLayer);
//            wallLayer.addBodyPolygon(10,100,0);
//            wallLayer = new LSprite();
//            wallLayer.x = 500;
//            wallLayer.y = 550;
//            backLayer.addChild(wallLayer);
//            wallLayer.addBodyPolygon(1000,10,0);
//            wallLayer = new LSprite();
//            wallLayer.x = 0;
//            wallLayer.y = 0;
//            backLayer.addChild(wallLayer);
//            wallLayer.addBodyPolygon(10,100,0);
            bStageInit();
            bulletInit();
            eStageInit();
            birdInit();
//            bStage=new LSprite();
            hero=new Chara();
            hero.x=140;
            hero.y=400;
            backLayer.addChild(hero);
            hero.changeAction();
            hero.anime.onframe();
            backLayer.addEventListener(LEvent.ENTER_FRAME,onframe);
            backLayer.addEventListener(LMouseEvent.MOUSE_UP,jump);
            setInterval(function(){
                birdInit();
            },2000)

        }
        function jump(event){
            hero.anime.setAction(0);
            setTimeout(function(){hero.anime.setAction(2);},200);
//            添加小鸟
            var speedX=15*( (500-event.offsetY)/(Math.sqrt((500-event.offsetY)*(500-event.offsetY)+ (event.offsetX-400)*(event.offsetX-400))));
            var speedY=15*((event.offsetX-400)/(Math.sqrt((500-event.offsetY)*(500-event.offsetY)+ (event.offsetX-400)*(event.offsetX-400))));
            var jiaodu=-90*((500-event.offsetY)/(Math.sqrt((500-event.offsetY)*(500-event.offsetY)+ (event.offsetX-400)*(event.offsetX-400))));
            bulletInit(speedX,speedY,jiaodu);
        }
        function onframe(){
            background.run();
            hero.anime.onframe();
            var key=null;
//            遍历子弹
            for(key in bStage.childList){
                var _child=bStage.childList[key];
                _child.y-=_child.speedX;
                _child.x+=_child.speedY;
             }
//            遍历小鸟
            var key2=null;
            for(key2 in eStage.childList){
                var _child=eStage.childList[key2];
//                console.log(_child.x);
                _child.x-=_child.speedX;
                _child.y+=_child.speedY;
//                检测碰撞
                if(_child.x<-800){
//                    alert("抱歉，你死了！！");
//                    window.location.reload();
                }
            }
            for(var i=0;i<bStage.childList.length;i++){
                var _child3=bStage.childList[i];
                for(var j=0;j<eStage.childList.length;j++){
                    var _child4=eStage.childList[j];
                    if(_child3.hitTestObject(_child4)){
                        bStage.removeChild(_child3);
                        eStage.removeChild(_child4);
                        console.log(_child3);
                        return;
                    }
                }
            }
//            var key3=null,key4=null;
//            for(key3 in bStage.childList){
//                var _child3=bStage.childList[key3];
//                for(key4 in eStage.childList){
//                    var _child4=eStage.childList[key4];
//                    if( _child3.hitTestObject(_child)){
//                    window.location.reload();
//                    }
//                }
//            }

        }
        //        背景类
        function BackGround(){
            base(this,LSprite,[]);
            var self=this;
            self.bitmapData=new LBitmapData(imgList["bg"]);
            self.bitmap1=new LBitmap(self.bitmapData);
            self.addChild(self.bitmap1);
            self.bitmap2=new LBitmap(self.bitmapData);
            self.bitmap2.x=self.bitmap1.getWidth();
            self.addChild(self.bitmap2);
            self.bitmap3=new LBitmap(self.bitmapData);
            self.bitmap3.x=self.bitmap1.getWidth()*2;
            self.addChild(self.bitmap3);
        }
        BackGround.prototype.run=function(){
            var self=this;
            self.bitmap1.x-=STAGE_STEP;
            self.bitmap2.x-=STAGE_STEP;
            self.bitmap3.x-=STAGE_STEP;
            if(self.bitmap1.x<-self.bitmap1.getWidth()){
                self.bitmap1.x=self.bitmap2.x;
                self.bitmap2.x=self.bitmap1.x+self.bitmap1.getWidth();
                self.bitmap3.x=self.bitmap1.x+self.bitmap1.getWidth()*2;
            }
        };
//        添加敌人
//        function stageInit(){
//            stageLayer=new LSprite();
//            backLayer.addChild(stageLayer);
//        }
        function Add(){
            base(this,LSprite,[]);
            var self=this;
            var rand = Math.random();
            if(rand <0.33){
                self.cLayer = new LSprite();
                self.cLayer.x = 700+ Math.random()*300;
                self.cLayer.y =50;
                backLayer.addChild( self.cLayer);
                self.bitmap = new LBitmap(new LBitmapData(imgList["bird1"]));
                self.cLayer.addChild(self.bitmap);
                self.body=self.cLayer.addBodyCircle(self.bitmap.getWidth()*0.5,self.bitmap.getHeight()*0.5,self.bitmap.getWidth()*0.5,1,.5,.4,.5);
//                var force = new b2Vec2(0, -16);
//                self.cLayer.box2dBody.ApplyForce(force,m_world);
                self.cLayer.setBodyMouseJoint(true);
            }else if(rand < 0.66){
                cLayer = new LSprite();
                backLayer.addChild(cLayer);
                bitmap = new LBitmap(new LBitmapData(imgList["bird2"]));
                cLayer.addChild(bitmap);
                var shapeArray = [
                    [[0,54],[27,0],[54,54]]
                ];
                cLayer.addBodyVertices(shapeArray,27,27,1,.5,.4,.5);
                cLayer.box2dBody.SetPosition(new LGlobal.box2d.b2Vec2((700 + Math.random()*300)/LGlobal.box2d.drawScale,50/LGlobal.box2d.drawScale));
            }else{
                cLayer = new LSprite();
                cLayer.x = 700+ Math.random()*300;
                cLayer.y = 50;
                backLayer.addChild(cLayer);
                bitmap = new LBitmap(new LBitmapData(imgList["band"]));
                cLayer.addChild(bitmap);
                cLayer.addBodyPolygon(bitmap.getWidth(),bitmap.getHeight(),1,5,.4,.2);
            }
        }
        Add.prototype.run=function(){
            var self=this;
            self.bitmap.x-=STAGE_STEP;
            self.onframe();
        };
        //        主角类
        function Chara(){
            base(this,LSprite,[]);
            var self=this;
            self.moveType="right";
            var list=LGlobal.divideCoordinate(3200,180,1,25);
            var data=new LBitmapData(imgList['man'],0,0,128,180);
//            self.addBodyPolygon(100,180,1,.5,.4,.5);
//            self.graphics.drawRect(1,"#FF0000",[0,0,100,100],true,"#FF0000");
            self.anime=new LAnimation(self,data,[
                [list[0][15]],
                [list[0],[7]],
                [list[0][0],list[0][1],list[0][2],list[0][3],list[0][4],list[0][5],list[0][6],list[0][7],list[0][8],list[0][9],list[0][10]],
                [list[0][23],list[0][21],list[0][20],list[0][19],list[0][17]]
            ])
        }
        Chara.prototype.changeAction=function(){
            var self=this;
            if(self.moveType=="left"){
                hero.anime.setAction(3);
            }else if(self.moveType=="right"){
                hero.anime.setAction(2)
            }else if(hero.isJump==1){
                hero.anime.setAction(1,0)
            }else{
                hero.anime.setAction(0,0)
            }
        };
//        子弹类
        function Bullet(x,y,jiaodu){
            base(this,LSprite,[]);
            var self=this;
            self.speed=2;
            self.speedX=x||10;
            self.speedY=y||10;
            self.bitmap=new LBitmap(new LBitmapData(imgList["bullet"],0,0,228,70));
            self.bitmap.x=250;
            self.bitmap.y=500;
//            self.bitmap.scaleX=.5;
//            self.bitmap.scaleY=.5;
            self.bitmap.rotate=jiaodu;
                        self.graphics.drawRect(1,"#FF0000",[280,500,100,50],true,"#FF0000");

            self.addChild(self.bitmap);
//            self.addBodyPolygon(self.bitmap.getWidth(),self.bitmap.getHeight(),1,5,.4,.2);
        }
        Bullet.prototype.onframe1=function(){

        };
        function bStageInit(){
            bStage=new LSprite();
            backLayer.addChild(bStage);
        }
        function bulletInit(x,y,jiaodu){
            bStage.addChild(new Bullet(x,y,jiaodu));
            aaa=1;
        }
//        Bullet.prototype.onframe=function(){
//            var self=this;
//            self.y-=new Bullet().speed;
//            if(self.child){
//                self.child.y-=speedY;
//                self.child.x+=speedX;
//            }
//        };
//        鸟类
        function Bird(){
            base(this,LSprite,[]);
            var self=this;
            var suiji=Math.random();
            if(suiji<0.5){
                self.bitmap=new LBitmap(new LBitmapData(imgList["bird1"],0,0,50,50));
            }else{
                self.bitmap=new LBitmap(new LBitmapData(imgList["bird2"],0,0,50,50));
            }

            self.bitmap.x=950;
            self.bitmap.y=400*Math.random();
//            self.bitmap.scaleX=2;
//            self.bitmap.scaleY=2;
            self.speedY=15*( (400-self.bitmap.y)/(Math.sqrt((400-self.bitmap.y)*(400-self.bitmap.y)+ ( self.bitmap.x-250)*( self.bitmap.x-250))));
            self.speedX=15*(( self.bitmap.x-250)/(Math.sqrt((400-self.bitmap.y)*(400-self.bitmap.y)+ ( self.bitmap.x-250)*( self.bitmap.x-250))));
            self.addChild(self.bitmap);
                        self.graphics.drawRect(1,"rgba(255,255,255,0)",[950,self.bitmap.y,100,100],true,"rgba(255,255,255,0)");

        }
        function eStageInit(){
            eStage=new LSprite();
            backLayer.addChild(eStage);
        }
        function birdInit(){
            var bird1=new Bird();
            eStage.addChild(bird1);
//            console.log(bird1);
        }
    </script>
</head>
<body style="background: #62ADF8;overflow: hidden">
    <div id="mylegend">loading...</div>
</body>
</html>